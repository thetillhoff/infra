# kubeadm init and kubeconfig creation

- run_once: true
  block:
  - stat:
      path: /etc/kubernetes/admin.conf
    register: kube_config
  - when: "not kube_config.stat.exists"
    block:
    - copy:
        dest: "/tmp/kubeadm-clusterconfiguration.yaml"
        content: |
          apiVersion: kubeadm.k8s.io/v1beta3
          kind: ClusterConfiguration
          controlPlaneEndpoint: "{{ lookup('env', 'CONTROL_PLANE_ENDPOINT') }}"
          #apiServer:
          #  extraArgs:
          #    enable-admission-plugins: DefaultIngressClass,DefaultStorageClass
    - command: "kubeadm init --config /tmp/kubeadm-clusterconfiguration.yaml --ignore-preflight-errors=NumCPU"

    - command: "kubectl taint nodes --all node-role.kubernetes.io/master-" # enable workloads on master nodes
      ignore_errors: yes
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf

  - name: Install helm3
    shell: curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
    args:
      creates: /usr/local/bin/helm
