- ufw: # allow connections to https
    rule: allow
    port: '443'
    proto: tcp

- shell: ./transcrypt -y -c aes-256-cbc -p "{{ lookup('env', 'TRANSCRYPT_PASSWORD') }}"
  ignore_errors: true # will fail if already configured
  args:
    chdir: infra

# install fluxcd
- shell: curl -s https://fluxcd.io/install.sh | sudo bash
  args:
    creates: /usr/local/bin/flux

- shell: | # Bootstrap flux
    flux bootstrap github \
    --owner=thetillhoff --repository=infra --path=kubernetes/clusters/{{ ansible_hostname }}
  environment:
    GITHUB_TOKEN: "{{ lookup('env', 'GH_TOKEN_FOR_FLUX') }}"
